<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PacMan</title>
</head>
<body>
  <canvas width="500" height="600"></canvas>
  <img hidden id="sprite" src="./Pacman Sprite.png" alt="Pacman Sprite">
  <style>
    body {
      background-color: #000;
    }

    canvas {
      margin: 0 auto;
      display: block;
    }
  </style>
  <script>
    const canvas = document.querySelector("canvas");
    const ctx = canvas.getContext("2d");
    const $sprite = document.getElementById("sprite");

    const pacmanMap = [
  "############################",
  "#............##............#",
  "#.####.#####.##.#####.####.#",
  "#o####.#####.##.#####.####o#",
  "#.####.#####.##.#####.####.#",
  "#..........................#",
  "#.####.##.########.##.####.#",
  "#.####.##.########.##.####.#",
  "#......##....##....##......#",
  "######.##### ## #####.######",
  "     #.##### ## #####.#     ",
  "     #.##          ##.#     ",
  "     #.## ###--### ##.#     ",
  "######.## #      # ##.######",
  "      .   #      #   .      ",
  "######.## #      # ##.######",
  "     #.## ######## ##.#     ",
  "     #.##          ##.#     ",
  "     #.## ######## ##.#     ",
  "######.## ######## ##.######",
  "#............##............#",
  "#.####.#####.##.#####.####.#",
  "#.####.#####.##.#####.####.#",
  "#o..##.......  .......##..o#",
  "###.##.##.########.##.##.###",
  "###.##.##.########.##.##.###",
  "#......##....##....##......#",
  "#.##########.##.##########.#",
  "#.##########.##.##########.#",
  "#..........................#",
  "############################"
].map(row => row.split(''));

    const pacmanWidth = 15;
    const pacmanHeight = 15;

    const wallWidth = 18;
    const wallHeight = 18;

    let pacmanX = 165;
    let pacmanY = 468;

    let rightPressed = false;
    let leftPressed = false;
    let upPressed = false;
    let downPressed = false;

    let mouthOpen = true;
    let lastAnimationTime = 0; // Variable to track the time of the last animation

    const animationDelay = 200;

    function drawPacmanOpenRight() {
      ctx.drawImage(
        $sprite,
        680 - 224,
        0,
        pacmanWidth,
        pacmanHeight,
        pacmanX,
        pacmanY,
        pacmanWidth,
        pacmanHeight
      );
    }

    function drawPacmanClosedRight() {
      ctx.drawImage(
        $sprite,
        680 - 208,
        0,
        pacmanWidth,
        pacmanHeight,
        pacmanX,
        pacmanY,
        pacmanWidth,
        pacmanHeight
      );
    }

    function drawPacmanOpenLeft() {
      ctx.drawImage(
        $sprite,
        680 - 208,
        16,
        pacmanWidth,
        pacmanHeight,
        pacmanX,
        pacmanY,
        pacmanWidth,
        pacmanHeight
      );
    }

    function drawPacmanClosedLeft() {
      ctx.drawImage(
        $sprite,
        680 - 224,
        16,
        pacmanWidth,
        pacmanHeight,
        pacmanX,
        pacmanY,
        pacmanWidth,
        pacmanHeight
      );
    }

    function drawPacmanOpenUp() {
      ctx.drawImage(
        $sprite,
        680 - 224,
        32,
        pacmanWidth,
        pacmanHeight,
        pacmanX,
        pacmanY,
        pacmanWidth,
        pacmanHeight
      );
    }

    function drawPacmanClosedUp() {
      ctx.drawImage(
        $sprite,
        680 - 208,
        32,
        pacmanWidth,
        pacmanHeight,
        pacmanX,
        pacmanY,
        pacmanWidth,
        pacmanHeight
      );
    }

    function drawPacmanOpenDown() {
      ctx.drawImage(
        $sprite,
        680 - 224,
        48,
        pacmanWidth,
        pacmanHeight,
        pacmanX,
        pacmanY,
        pacmanWidth,
        pacmanHeight
      );
    }

    function drawPacmanClosedDown() {
      ctx.drawImage(
        $sprite,
        680 - 208,
        48,
        pacmanWidth,
        pacmanHeight,
        pacmanX,
        pacmanY,
        pacmanWidth,
        pacmanHeight
      );
    }

    function drawMap() {
      for(let i = 0; i < pacmanMap.length; i++) {
        for(let j = 0; j < pacmanMap[i].length; j++) {
          const xPos = j * wallWidth;
          const yPos = i * wallHeight;

          if(pacmanMap[i][j] === "#") {
            drawWall(xPos, yPos, "blue")
          } else if(pacmanMap[i][j] === ".") {
            
          } else if(pacmanMap[i][j] === "o") {
            
          } else if(pacmanMap[i][j] === "-") {
            drawWall(xPos, yPos, "gray")
          }
        }
      }
    }

    function drawWall(xPos, yPos, color) {
      ctx.fillStyle = color;
      ctx.fillRect(xPos, yPos, wallWidth, wallHeight)
    }

    function drawPath(xPos, yPos) {
      ctx.beginPath();
      ctx.fillStyle = "yellow";
      ctx.arc(xPos + wallWidth / 2, yPos + wallHeight / 2, 2, 0, 2 * Math.PI, false);
      ctx.fill()
      ctx.closePath()
    }

    function drawEat(xPos, yPos) {
      ctx.beginPath();
      ctx.fillStyle = "yellow";
      ctx.arc(xPos + wallWidth / 2, yPos + wallHeight / 2, 4, 0, 2 * Math.PI, false);
      ctx.fill()
      ctx.closePath()
    }


    function pacmanAnimation(currentTime) {
      if(currentTime - lastAnimationTime > animationDelay) {
        mouthOpen = !mouthOpen; // Toggle mouth state
        lastAnimationTime = currentTime;
      }
    }

    function pacmanMovement() {
      let collision = false;

      for (let i = 0; i < pacmanMap.length; i++) {
        for (let j = 0; j < pacmanMap[i].length; j++) {
          const xPos = j * wallWidth;
          const yPos = i * wallHeight;

          if (pacmanMap[i][j] === "#") {
            const wallLeft = xPos;
            const wallRight = xPos + wallWidth;
            const wallTop = yPos;
            const wallBottom = yPos + wallHeight;

            // Calculate the bounding box of Pacman
            const pacmanLeft = pacmanX;
            const pacmanRight = pacmanX + pacmanWidth;
            const pacmanTop = pacmanY;
            const pacmanBottom = pacmanY + pacmanHeight;

            if (
              pacmanRight > wallLeft &&
              pacmanLeft < wallRight &&
              pacmanBottom > wallTop &&
              pacmanTop < wallBottom
            ) {
              console.log("collide");
              collision = true;
              break;
            }
          }
        }
        if (collision) break;
      }

      if (collision) {
        // Move Pacman away from the wall based on his current direction
        if (rightPressed && pacmanX < canvas.width - pacmanWidth) {
          pacmanX -= 2;
          pacmanX += 0;
          pacmanY += 0;
          rightPressed = false;
        } else if (upPressed && pacmanY > 0) {
          pacmanY += 2;
          pacmanX += 0;
          pacmanY += 0;
          upPressed = false;
        } else if (downPressed && pacmanY < canvas.height - pacmanHeight) {
          pacmanY -= 2;
          pacmanX += 0;
          pacmanY += 0;
          downPressed = false;
        } else if (leftPressed && pacmanX > 0) {
          pacmanX += 2;
          pacmanX += 0;
          pacmanY += 0;
          leftPressed = false;
        }

        return;
      } 

      if (rightPressed && pacmanX < canvas.width - pacmanWidth) {
        pacmanX += 2;
      } else if (upPressed && pacmanY > 0) {
        pacmanY -= 2;
      } else if (downPressed && pacmanY < canvas.height - pacmanHeight) {
        pacmanY += 2;
      } else if (leftPressed && pacmanX > 0) {
        pacmanX -= 2;
      }
    }

    function initEvents() {
      document.addEventListener('keydown', keyDownHandler)

      function keyDownHandler(event) {
        const { key } = event

        if(key !== 'Rigth' && key !== 'ArrowRight' && key.toLowerCase() !== 'd'
        && key !== 'Left' && key !== 'ArrowLeft' && key.toLowerCase() !== 'a'
        && key !== 'Up' && key !== 'ArrowUp' && key.toLowerCase() !== 'w'
        && key !== 'Down' && key !== 'ArrowDown' && key.toLowerCase() !== 's') {

          return
        }

        if(rightPressed || leftPressed || upPressed || downPressed) {
          rightPressed = false;
          leftPressed = false;
          upPressed = false;
          downPressed = false;
        }

        if (key === 'Right' || key === 'ArrowRight' || key.toLowerCase() === 'd') {
          rightPressed = true;
        } else if (key === 'Left' || key === 'ArrowLeft' || key.toLowerCase() === 'a') {
          leftPressed = true;
        } else if(key === 'Up' || key === 'ArrowUp' || key.toLowerCase() === 'w') {
          upPressed = true;
        } else if(key === 'Down' || key === 'ArrowDown' || key.toLowerCase() === 's') {
          downPressed = true;
        }
      }
    }

    function draw() {
      window.requestAnimationFrame(draw);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawMap()

      const currentTime = performance.now();
      pacmanAnimation(currentTime);

      if(!rightPressed && !leftPressed && !upPressed
        && !downPressed
      ) {
        drawPacmanClosedRight();
      }

      // Draw Pacman based on mouth state
      if (mouthOpen && rightPressed) {
        drawPacmanOpenRight();
      } else if(rightPressed) {
        drawPacmanClosedRight();
      }

      if (mouthOpen && leftPressed) {
        drawPacmanOpenLeft();
      } else if(leftPressed) {
        drawPacmanClosedLeft();
      }

      if (mouthOpen && upPressed) {
        drawPacmanOpenUp();
      } else if(upPressed) {
        drawPacmanClosedUp();
      }

      if (mouthOpen && downPressed) {
        drawPacmanOpenDown();
      } else if(downPressed) {
        drawPacmanClosedDown();
      }
      
      pacmanMovement();
    }

    draw();
    initEvents();
  </script>
</body>
</html>
